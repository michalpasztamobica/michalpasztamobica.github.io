
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Register Classes &#8212; Flang 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Error Messages" href="errmsg.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>Flang 1.0 documentation</span></a></h1>
        <h2 class="heading"><span>Register Classes</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="errmsg.html">Error Messages</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="register-classes">
<h1>Register Classes<a class="headerlink" href="#register-classes" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Two views of registers are used throughout the compiler:
<em>generic</em>
<em>registers</em>
and
<em>machine</em>
<em>registers</em>.
To facilitate retargeting, several classes of generic registers are
defined to hide the machine registers from various phases of the compiler.
Generic registers are mapped to machine registers with the likelihood
that more than one class of generic registers map to a single class of
machine registers.
A generic register class exists for each of the register types seen by
the ILI:
address register, integer register (integers, booleans, char, etc.),
single precision register, and double precision register.
The generic register mappings
are primarily used by the expander and optimizer when
assigning global registers.</p>
<p>Depending on the target
register numbers, when used as operands to ILI, reflect either
actual machine register numbers or numbers which are mapped by
the code scheduler to actual machine numbers.
Registers can be used as arguments for calling intrinsics,
and as operands to register define and move ILI.  In the latter case,
these ILI are typically generated by the expander and optimizer
when registers have been assigned globally.</p>
</div>
<div class="section" id="data-structures">
<h2>Data Structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<div class="section" id="machine-register-table">
<h3>Machine Register Table<a class="headerlink" href="#machine-register-table" title="Permalink to this headline">¶</a></h3>
<p>The target machine registers are divided into classes appropriate for
the target’s architecture.
Each machine register set has the following properities:</p>
<ol class="arabic simple">
<li>each class is expressed as a set of increasing order of numbers.</li>
<li>the scratch registers are defined by the code scheduler</li>
<li>the global registers are allocated either in decreasing or increasing
order from a given point.</li>
<li>the scratch registers that can be changed by a
procedure and intrinsic.</li>
</ol>
<p>A machine register table is used to define the classes of machine registers,
where there is one entry for each class.
A table entry is defined by the following C structure declaration:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>typedef struct {
    char min;
    char max;
    char first_global;
    char last_global;
    char next_global;
    char nused;
} MACH_REG;
</pre></div>
</div>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">min</span></code></dt>
<dd>minimum register number of the set.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">max</span></code></dt>
<dd>maximum register number of the set (the set is defined by the closed
interval <code class="docutils literal notranslate"><span class="pre">[min..max]</span></code>).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">first_global</span></code></dt>
<dd>the first register number that can be global register.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">last_global</span></code></dt>
<dd>the last register number that can be global.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">next_global</span></code></dt>
<dd>the next register number that can be globally assigned.
In the event that not all of the registers in the global set are assigned
by the expander or optimizer,
the scheduler may use the global registers not assigned as
<em>scratch</em>
registers.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nused</span></code></dt>
<dd>the number of global registers assigned by the expander or optimizer.</dd>
</dl>
<p>All but the fields <code class="docutils literal notranslate"><span class="pre">next_global</span></code> and <code class="docutils literal notranslate"><span class="pre">nused</span></code> are statically
initialized; <code class="docutils literal notranslate"><span class="pre">next_global</span></code> and <code class="docutils literal notranslate"><span class="pre">nused</span></code>
are modified when registers are allocated globally
during the expander and optimizer phases.</p>
<p>It is possible that a machine’s registers cannot be expressed
as the closed interval <code class="docutils literal notranslate"><span class="pre">[min</span> <span class="pre">..</span> <span class="pre">max]</span></code>.
If this occurs, the machine register table will describe
“pseudo” machine registers which adhere to the above properties.
These pseudo machine registers would be mapped to the actual machine registers.
The ILI, expander, and optimizer would still refer to the registers from
the machine register table.
The scheduler would use the pseudo to machine register mapping when it’s
neccessary to refer to an actual machine register.</p>
</div>
<div class="section" id="generic-register-table">
<h3>Generic Register Table<a class="headerlink" href="#generic-register-table" title="Permalink to this headline">¶</a></h3>
<p>The generic registers are divided into classes of registers which correspond
to the types of the registers seen by the ILI.
The mapping of generic registers to machine registers is described in
the generic register table.
Each table entry not only describes the mapping but
provides information regarding global register allocation.
Each table entry is defined by the following C structure declaration:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>typedef struct {
    char      max;
    char      nused;
    char      joined;
    int       rcand;
    MACH_REG \*mach_reg;
    INT       const_flag;
} REG;
</pre></div>
</div>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">max</span></code></dt>
<dd>the maximum number of registers that can be globally assigned.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nused</span></code></dt>
<dd>the number of registers globally assigned.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">joined</span></code></dt>
<dd>flag indicating that the registers are formed from multiple
machine registers.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rcand</span></code></dt>
<dd>list of global register candidates.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mach_reg</span></code></dt>
<dd>pointer to the machine register table entry of the machine registers
to which the generic class maps.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const_flag</span></code></dt>
<dd>a flag word which controls the assignment of constants to registers.
The fields <code class="docutils literal notranslate"><span class="pre">max</span></code>, <code class="docutils literal notranslate"><span class="pre">joined</span></code>, <code class="docutils literal notranslate"><span class="pre">mach_reg</span></code>,
and <code class="docutils literal notranslate"><span class="pre">const_flag</span></code> are statically initialized;
fields <code class="docutils literal notranslate"><span class="pre">nused</span></code> and <code class="docutils literal notranslate"><span class="pre">rcand</span></code> in module
<em>machreg.c</em>
are modified when registers are allocated globally
during the expander and optimizer phases.</dd>
</dl>
</div>
</div>
<div class="section" id="processing">
<h2>Processing<a class="headerlink" href="#processing" title="Permalink to this headline">¶</a></h2>
<p>The file
<em>machreg.h</em>
contains the specifics for the target machine’s registers such as
definitions for the <code class="docutils literal notranslate"><span class="pre">mach_reg</span></code>
structure, external declarations for the functions used to access
the structure, and
macro definitions used to represent various pieces of the machine
registers.
When constructing
<em>machreg.h</em>,
certain macros must be present:
those which deal with register arguments and
those which describe the machine registers.
Argument macros are present which provided the register numbers for
accessing
<em>argument</em>
<em>registers</em>
where the arguments to the macros are machine dependent.
There is one macro for each register type:</p>
<dl class="docutils">
<dt>AR(i)</dt>
<dd>define an address register</dd>
<dt>IR(i)</dt>
<dd>define a integer register</dd>
<dt>SP(i)</dt>
<dd>define a single precision register for argument</dd>
<dt>DP(i)</dt>
<dd>define a double precision register for argument</dd>
<dt>ISP(i)</dt>
<dd>define a single precision register for an imaginary argument</dd>
<dt>IDP(i)</dt>
<dd>define a double precision register for an imaginary argument</dd>
</dl>
<div class="section" id="machine-register-macros">
<h3>Machine Register Macros<a class="headerlink" href="#machine-register-macros" title="Permalink to this headline">¶</a></h3>
<p>Special macros are used for defining the global registers in each
of the unique register classes (the macro
<code class="docutils literal notranslate"><span class="pre">MR_UNIQ</span></code>
gives the number of unique classes).
For each global set, the lower and upper bounds are specified in the
form
<code class="docutils literal notranslate"><span class="pre">MR_L&lt;i&gt;</span></code>
to
<code class="docutils literal notranslate"><span class="pre">MR_U&lt;i&gt;</span></code>,
where &lt;i&gt; = 1 to
<code class="docutils literal notranslate"><span class="pre">MR_UNIQ</span></code>.
For example, if there are 2 unique classes, then the interval defined
by macros
<code class="docutils literal notranslate"><span class="pre">MR_L1</span></code>
to
<code class="docutils literal notranslate"><span class="pre">MR_U1</span></code>
defines
the global registers for set 1 and macros
<code class="docutils literal notranslate"><span class="pre">MR_L2</span></code>
to
<code class="docutils literal notranslate"><span class="pre">MR_U2</span></code>
defines
the global registers for set 2.
Note that the file
<em>machregdf.h</em>
uses these macros to data initialize the
<code class="docutils literal notranslate"><span class="pre">mach_reg</span></code>
table.</p>
<p>The macro,
<code class="docutils literal notranslate"><span class="pre">MR_NUMGLB</span></code>,
defines the total number of global registers for the machine.
This macro is used by the optimizer to declare space for its
global register history data structures.</p>
<p>The macro GR_THRESHOLD defines the count which a candidate must
exceed before it’s assigned a register.</p>
</div>
</div>
<div class="section" id="program-units">
<h2>Program Units<a class="headerlink" href="#program-units" title="Permalink to this headline">¶</a></h2>
<p>The register module is composed of the C files
<em>register.c</em>
and
<em>machreg.c</em>.
The file
<em>register.c</em>
contains the following routines:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void reg_init()
</pre></div>
</div>
<ul class="simple">
<li>This function initializes the register information for a function
or subprogram which is passed on to the code generator and assembler.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void addrcand(ili)
int ili;
</pre></div>
</div>
<ul class="simple">
<li>Add an ili to its register candidate list.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void dmprcand()
</pre></div>
</div>
<ul class="simple">
<li>Dump the register candidate lists.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void dmprat(rat)
int rat;
</pre></div>
</div>
<ul class="simple">
<li>Dump the register assigned table indexed by
<code class="docutils literal notranslate"><span class="pre">rat</span></code>.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int getrcand(candl)
int candl;
</pre></div>
</div>
<ul class="simple">
<li>Gets a register candidate for the list <code class="docutils literal notranslate"><span class="pre">candl</span></code>.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void storedums(bih, rat)
int bih, rat;
</pre></div>
</div>
<ul class="simple">
<li>Generates stores of the registers in the table <a href="#id1"><span class="problematic" id="id2">``</span></a>``
assigned to Fortran dummy arguments.
These stores are added to the block located by
the block information header, <code class="docutils literal notranslate"><span class="pre">bih</span></code>.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void mkrtemp_init()
</pre></div>
</div>
<ul class="simple">
<li>Initialize the register temporary areas; this is done when
unique temps are desired during the processing of a
unit (i.e., for an ILM block) but are still
shared with the previous unit.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int mkrtemp(ili)
int ili;
</pre></div>
</div>
<ul class="simple">
<li>Gets a register temporary whose register type is based on
the type of <code class="docutils literal notranslate"><span class="pre">ili</span></code>.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void mkrtemp_end()
</pre></div>
</div>
<ul class="simple">
<li>Routine called at the end of processing a function to
so that the temps created for the next function are
unique.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void mkrtemp_update(rtemp)
short rtemp[];
</pre></div>
</div>
<ul class="simple">
<li>Update the maximum values for the register temporaries whose
information is stored in <code class="docutils literal notranslate"><span class="pre">rtemp</span></code>.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void mkrtemp_copy(rtemp)
short rtemp[];
</pre></div>
</div>
<ul class="simple">
<li>Copy the maximum values of the temporaries which have been
allocated to the area <code class="docutils literal notranslate"><span class="pre">rtemp</span></code>.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int assn_rtemp(ili)
int ili;
</pre></div>
</div>
<ul class="simple">
<li>Create a register temporary for <code class="docutils literal notranslate"><span class="pre">ili</span></code> and record
the temporary and the ili in the appropriate register
candidate list.</li>
</ul>
<p>.The file
<em>machreg.c</em>
contains the following routines:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>void mr_init()
</pre></div>
</div>
<ul class="simple">
<li>This function initializes the fields of the
structures,
<code class="docutils literal notranslate"><span class="pre">mach_reg</span></code>
and
<code class="docutils literal notranslate"><span class="pre">reg</span></code>,
for the current function or subprogram
which are not statically initialized.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int mr_getreg(rtype)
int rtype;
</pre></div>
</div>
<ul class="simple">
<li>This function returns a global machine register number
for the register type specified by
<code class="docutils literal notranslate"><span class="pre">rtype</span></code>.
If one is not available,
<code class="docutils literal notranslate"><span class="pre">MR_NOREG</span></code>
is returned.</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int mr_gindex(rtype, reg)
int rtype, reg;
</pre></div>
</div>
<ul class="simple">
<li>This function maps a register type,
<code class="docutils literal notranslate"><span class="pre">rtype</span></code>,
and a global machine register number,
<code class="docutils literal notranslate"><span class="pre">reg</span></code>,
to an index value in the range
<code class="docutils literal notranslate"><span class="pre">0..MR_NUMGLB-1</span></code>.
This routine is aware that certain register types may map to the
same machine register set.
This routine provides a mechanism for ensuring that the history
of a machine register can be kept regardless of the many to one register
type mapping.</li>
</ul>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="errmsg.html">Error Messages</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright .
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>